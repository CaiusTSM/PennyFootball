<html>
	<head>
		<meta charset="utf-8">
	    <meta name="viewport" content="width=device-width">
	    <meta name="description" content="Penny Football Project">
	  	<meta name="author" content="Agile Team 2">
    	<title>Penny Football</title>
		<script src="/jquery.js"></script>
		<script src="/socket.io.js"></script>
		<script src="/socket.js"></script>
		<script src="/reload-client.js"></script>
		<script src="/fpsmeter.js"></script>
		<script src="/planck.js"></script>
		<script>
			$(document).ready(function() {
				var game = new Game();
				game.init();
				game.start();
			});
			
			function timestamp() {
				return window.performance && window.performance.now ? window.performance.now() : new Date().getTime()
			}
			
			var Timer = function() {
				this.startTime = 0;
				this.endTime = 0;
				
				this.start = function() {
					this.startTime = timestamp();
				};
				
				this.elapsed = function() {
					this.endTime = timestamp();
					var timeDiff = this.endTime - this.startTime;
					return timeDiff;
				};
			}
			
			var Ground = function(world, viewWidth, viewHeight) {
				this.bodyDef = {};
				
				this.width = 1;
				this.height = 1;
				this.shape = planck.Box(this.width, this.height);
				
				this.fixDef = {
					density: 1.0,
					friction: 0.5,
					restitution: 0.2
				};
				
				this.body = world.createBody(this.bodyDef);
				this.body.setPosition(planck.Vec2(0, 5));
				
				this.fixture = this.body.createFixture(this.shape, this.fixDef);
				
				this.render = function(ctx, scale) {
					ctx.fillStyle = "#357654";
					ctx.fillRect(this.body.getPosition().x * scale, this.body.getPosition().y * scale, this.width * scale, this.height * scale);
				};
			};
			
			var Game = function() {
				this.canvas = null;
				this.ctx = null;
				
				this.fitByMax = true;
				
				this.viewWidth = 20;
				this.viewHeight = 20;
				this.viewMax = this.viewWidth;
				this.viewMin = this.viewWidth;
				
				this.canvasWidth = 0;
				this.canvasHeight = 0;
				this.canvasMax = this.canvasWidth;
				this.canvasMin = this.canvasWidth;
				
				this.timer = null;
				this.timestep = 1.0 / 60.0;
				this.timePassed = 0;
				
				this.fpsmeter = null;
				
				this.world = null;
				this.ground = null;
				this.boxes = [];
				
				this.initialized = false;
				
				this.init = function() {
					// Find the canvas and get the context
					this.canvas = document.getElementById("gameCanvas");
					this.ctx = this.canvas.getContext("2d");
					
					this.fitByMax = false;
					
					// Setup the virtual view
					this.viewWidth = 20;
					this.viewHeight = 20;
					if (this.viewWidth > this.viewHeight) {
						this.viewMax = this.viewWidth;
						this.viewMin = this.viewHeight;
					}
					else {
						this.viewMax = this.viewHeight;
						this.viewMin = this.viewWidth;
					}
					
					// Setup the real view according to actual canvas size
					if (this.fitByMax === true) {
						this.canvas.width = this.canvas.parentElement.clientWidth;
						this.canvas.height = this.canvas.parentElement.clientHeight;
						this.canvas.style.left = "0px";
						this.canvas.style.top = "0px";
					}
					else {
						var lesser = this.canvas.parentElement.clientWidth < this.canvas.parentElement.clientHeight ? this.canvas.parentElement.clientWidth : this.canvas.parentElement.clientHeight;
						this.canvas.width = lesser;
						this.canvas.height = lesser;
						this.canvas.style.left = "" + (this.canvas.parentElement.clientWidth / 2 - this.canvas.width / 2) + "px";
						this.canvas.style.top = "" + (this.canvas.parentElement.clientHeight / 2 - this.canvas.height / 2) + "px";
					}
					
					this.canvasWidth = this.canvas.width;
					this.canvasHeight = this.canvas.height;
					if (this.canvasWidth > this.canvasHeight) {
						this.canvasMax = this.canvasWidth;
						this.canvasMin = this.canvasHeight;
					}
					else {
						this.canvasMax = this.canvasHeight;
						this.canvasMin = this.canvasWidth;
					}
					
					this.timer = new Timer();
					this.timestep = 1.0 / 60.0;
					this.timePassed = 0;
					
					this.fpsmeter = new FPSMeter({decimals: 0, graph: true, theme: "dark", left: "30%"});
					
					this.world = new planck.World(planck.Vec2(0.0, -10.0), true);
					this.ground = new Ground(this.world, this.viewWidth, this.viewHeight);
					this.boxes = [];
					
					this.initialized = true;
				};
				
				this.start = function() {
					if (this.initialized === true) {
						this.timer.start();
						requestAnimationFrame(this.loop);
					}
					else {
						console.log("Error: Started game without initialization.");
					}
				};
				
				this.loop = function() {
					this.fpsmeter.tickStart();
					
					// Set the real view according to actual canvas size (in loop since the player can resize the window)
					if (this.fitByMax === true) {
						this.canvas.width = this.canvas.parentElement.clientWidth;
						this.canvas.height = this.canvas.parentElement.clientHeight;
						this.canvas.style.left = "0px";
						this.canvas.style.top = "0px";
					}
					else {
						var lesser = this.canvas.parentElement.clientWidth < this.canvas.parentElement.clientHeight ? this.canvas.parentElement.clientWidth : this.canvas.parentElement.clientHeight;
						this.canvas.width = lesser;
						this.canvas.height = lesser;
						this.canvas.style.left = "" + (this.canvas.parentElement.clientWidth / 2 - this.canvas.width / 2) + "px";
						this.canvas.style.top = "" + (this.canvas.parentElement.clientHeight / 2 - this.canvas.height / 2) + "px";
					}
					
					this.canvasWidth = this.canvas.width;
					this.canvasHeight = this.canvas.height;
					if (this.canvasWidth > this.canvasHeight) {
						this.canvasMax = this.canvasWidth;
						this.canvasMin = this.canvasHeight;
					}
					else {
						this.canvasMax = this.canvasHeight;
						this.canvasMin = this.canvasWidth;
					}
					
					// Compute time passed, restart timer, add to time passed (capped to max 1 second)
					var dt = this.timer.elapsed() / 1000.0;
					this.timer.start();
					this.timePassed += Math.min(1, dt);
					
					// tick at fixed timestep
					while (this.timePassed >= this.timeStep) {
						this.timePassed -= this.timeStep;
						this.tick(this.timeStep);
					}
					
					// render at non-fixed timestep (as fast as this loop runs)
					// scale by min (creates black bars at sides like when putting a square video on a tv screen)
					this.render(dt, this.canvasMin / this.viewMin);
					
					this.fpsmeter.tick();
					
					requestAnimationFrame(this.loop);
				}.bind(this);
				// This bind thing is so "this" still points to the right thing when using requestAnimationFrame
				
				// Game logic goes here
				this.tick = function(dt) {
					
				};
				
				// Game rendering (drawing) goes here
				this.render = function(dt, scale) {
					this.ground.render(this.ctx, scale);
				};
			};
		</script>
		<style>
			body {
				width: 100%;
				height: 100%;
				
				margin: 0;
				padding: 0;
			}
		
			.wrapper {
				width: 100%;
				height: 100%;
				
				margin: 0;
				padding: 0;
				
				background: #aaa;
			}
			
			.chatDiv {
				float: left;
				
				width: 25%;
				height: 100%;
				
				margin: 0;
				padding: 0;
				
				background: #444;
			}
			
			.gameDiv {
				float: right;
				
				width: 75%;
				height: 100%;
				
				margin: 0;
				padding: 0;
				
				background: #9348f2;
			}
			
			.chatList {
				width: 100%;
				height: 85%;
				
				margin: 0;
				padding: 0;
				
				background: #eee;
			}
			
			.chatInput {
				width: 100%;
				height: 12%;
				
				margin: 0;
				padding: 0;
				
				border: none;
				
				background: #bbb;
				
				font-size: 16;
			}
			
			#chatSubmitButton {
				width: 100%;
				height: 3%;
				
				background: #575329;
			}
			
			#gameCanvas {
				position: relative;
				
				margin: 0;
				padding: 0;
				
				background: #222;
			}
		</style>
	</head>
	
	<body>
		<div class="wrapper">
			<div class="chatDiv">
				<ul id="chatList" class="chatList"></ul>
				<textarea class="chatInput" rows="4" cols="50"></textarea>
				<input type="button" id="chatSubmitButton" value="Send"></input>
			</div>
			<div class="gameDiv">
				<canvas id="gameCanvas"></canvas>
			</div>
		</div>
	</body>
</html>